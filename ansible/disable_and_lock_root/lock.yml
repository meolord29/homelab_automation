---
- name: Fully Disable and Lock Root Account
  hosts: all
  become: yes
  tasks:
    # 1. SYSTEM LEVEL: Lock password and remove shell
    - name: Lock root user and disable shell
      ansible.builtin.user:
        name: root
        password_lock: yes        # Disables password auth (adds '!')
        shell: /usr/sbin/nologin  # Prevents interactive shell access
      
    # 2. SSH LEVEL: Modify main config
    - name: Disable Root Login in Main SSH Config
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^PermitRootLogin'
        line: 'PermitRootLogin no'
        state: present
        validate: '/usr/sbin/sshd -t -f %s'
      notify: Restart SSH

    # 3. SSH LEVEL (UBUNTU SPECIFIC): Handle drop-in configs
    # Modern Ubuntu often overrides settings in /etc/ssh/sshd_config.d/
    # usually via 50-cloud-init.conf. We must check these too.
    - name: Find SSH include files
      ansible.builtin.find:
        paths: /etc/ssh/sshd_config.d/
        patterns: "*.conf"
      register: ssh_includes

    - name: Disable Root Login in SSH include files
      ansible.builtin.replace:
        path: "{{ item.path }}"
        regexp: '^PermitRootLogin.*$'
        replace: 'PermitRootLogin no'
      with_items: "{{ ssh_includes.files }}"
      when: ssh_includes.matched > 0
      notify: Restart SSH

  handlers:
    - name: Restart SSH
      ansible.builtin.service:
        name: ssh
        state: restarted